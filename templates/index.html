<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ტრანსლიტერატორი</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "blue-custom": "#4285f4",
            },
          },
        },
      };
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-custom text-white px-6 py-4">
      <div class="max-w-4xl mx-auto flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <div class="bg-white bg-opacity-20 p-2 rounded">
            <i class="fas fa-language text-xl"></i>
          </div>
          <h1 class="text-xl font-medium">ტრანსლიტერატორი</h1>
        </div>
        <button
          class="flex items-center space-x-2 bg-white bg-opacity-10 hover:bg-opacity-20 px-3 py-2 rounded transition-colors"
          onclick="openHistoryModal()"
        >
          <i class="fas fa-history"></i>
          <span>ისტორია</span>
        </button>
      </div>
    </header>

    <!-- History Modal -->
    <div
      id="historyModal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-96 overflow-hidden"
      >
        <!-- Modal Header -->
        <div
          class="flex items-center justify-between p-4 border-b border-gray-200"
        >
          <h2 class="text-xl font-semibold text-gray-800 flex items-center">
            <i class="fas fa-history mr-2 text-blue-custom"></i>
            ტრანსლიტერაციის ისტორია
          </h2>
          <div class="flex items-center space-x-2">
            <button
              onclick="clearHistory()"
              class="text-red-500 hover:text-red-700 px-3 py-1 rounded text-sm font-medium transition-colors"
            >
              <i class="fas fa-trash mr-1"></i>
              გასუფთავება
            </button>
            <button
              onclick="closeHistoryModal()"
              class="text-gray-400 hover:text-gray-600 p-1"
            >
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
        </div>

        <!-- Modal Content -->
        <div class="overflow-y-auto max-h-80">
          <div id="historyContent" class="p-4">
            <!-- History items will be inserted here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-6 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Chinese Input Section -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
          <!-- Language Header -->
          <div class="flex items-center p-4 border-b border-gray-100">
            <div class="flex items-center space-x-2">
              <span class="font-medium text-gray-700">ჩინური</span>
            </div>
          </div>
          <!-- Input Area -->
          <div class="relative">
            <textarea
              id="chineseInput"
              class="w-full h-64 p-4 text-lg resize-none border-none outline-none placeholder-gray-400"
              placeholder="ჩაწერეთ ჩინური ტექსტი..."
              maxlength="80"
              oninput="handleInput()"
              onkeyup="updateCharCount()"
            ></textarea>

            <!-- Pinyin Tag Display -->
            <div
              id="pinyinTag"
              class="hidden absolute bottom-16 left-4 right-4"
            >
              <div
                class="bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full border border-blue-200 inline-flex items-center space-x-2"
              >
                <div>
                  <span class="text-xs font-semibold mr-1">Pinyin:</span>
                  <span class="font-mono" id="pinyinText"></span>
                </div>
                <div id="otherPinyinWrapper" class="hidden">
                  <span class="text-xs font-semibold mx-2">Other:</span>
                  <span class="font-mono" id="otherPinyinText"></span>
                </div>
              </div>
            </div>

            <!-- Bottom Controls -->
            <div
              class="flex items-center justify-between p-4 border-t border-gray-100"
            >
              <div class="text-sm text-gray-500">
                <span id="charCount">0</span> / 80
              </div>
              <div class="flex items-center space-x-3">
                <!-- Voice input removed for production stability -->
              </div>
            </div>
          </div>
        </div>

        <!-- Georgian Output Section -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
          <!-- Language Header -->
          <div class="flex items-center p-4 border-b border-gray-100">
            <div class="flex items-center space-x-2">
              <span class="font-medium text-gray-700">ქართული</span>
            </div>
          </div>

          <!-- Output Area -->
          <div class="relative">
            <div
              id="georgianOutput"
              class="w-full h-64 p-4 text-lg text-gray-400 overflow-y-auto"
            >
              ტრანსლიტერაცია გამოჩნდება აქ...
            </div>

            <!-- Bottom Controls -->
            <div
              class="flex items-center justify-between p-4 border-t border-gray-100"
            >
              <div class="text-sm text-gray-500">
                <!-- Empty space for alignment -->
              </div>
              <div class="flex items-center space-x-3">
                <button
                  id="copyBtn"
                  class="p-2 text-gray-400 hover:text-gray-600 transition-colors opacity-50"
                  title="Copy"
                  disabled
                >
                  <i class="fas fa-copy text-lg"></i>
                </button>
                <button
                  id="shareBtn"
                  class="p-2 text-gray-400 hover:text-gray-600 transition-colors opacity-50"
                  title="Share"
                  disabled
                >
                  <i class="fas fa-share text-lg"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer Credits -->
      <footer class="text-center text-sm text-gray-500 mt-8">
        შექმნილია <span class="text-red-500">❤</span> სსიპ სახელმწიფო ენის
        დეპარტამენტის © მიერ 2025
        <div class="mt-2 space-x-4">
          <a href="#" class="hover:text-blue-custom transition-colors"
            >კონფიდენციალურობა</a
          >
          <span>•</span>
          <a href="#" class="hover:text-blue-custom transition-colors"
            >წესები</a
          >
          <span>•</span>
          <a href="#" class="hover:text-blue-custom transition-colors"
            >კონტაქტი</a
          >
        </div>
      </footer>
    </main>

    <script>
      let isTranslating = false;
      let debounceTimer = null;
      let currentMode = "chinese";

      // Mode switching functionality
      function setMode(mode) {
        currentMode = mode;
        const input = document.getElementById("chineseInput");
        const chineseBtn = document.getElementById("chineseMode");
        const pinyinBtn = document.getElementById("pinyinMode");

        if (mode === "chinese") {
          // Update buttons
          chineseBtn.className =
            "flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors bg-blue-custom text-white";
          pinyinBtn.className =
            "flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-800";

          // Update placeholder
          input.placeholder = "Type or paste Chinese text...";
        } else {
          // Update buttons
          pinyinBtn.className =
            "flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors bg-blue-custom text-white";
          chineseBtn.className =
            "flex-1 py-2 px-3 text-sm font-medium rounded-md transition-colors text-gray-600 hover:text-gray-800";

          // Update placeholder
          input.placeholder = "Type pinyin (e.g., beijing, shanghai)...";
        }

        // Clear current input and output
        input.value = "";
        updateCharCount();
        const output = document.getElementById("georgianOutput");
        output.textContent = "ტრანსლიტერაცია გამოჩნდება აქ...";
        output.className =
          "w-full h-64 p-4 text-lg text-gray-400 overflow-y-auto";

        // Hide pinyin tag when switching modes
        document.getElementById("pinyinTag").classList.add("hidden");

        // Disable buttons
        const copyBtn = document.getElementById("copyBtn");
        const shareBtn = document.getElementById("shareBtn");
        copyBtn.disabled = true;
        shareBtn.disabled = true;
        copyBtn.classList.add("opacity-50");
        shareBtn.classList.add("opacity-50");
      }

      // History management
      function saveToHistory(chineseText, georgianText, pinyinText) {
        const historyItem = {
          id: Date.now(),
          chinese: chineseText,
          georgian: georgianText,
          pinyin: pinyinText,
          timestamp: new Date().toISOString(),
        };

        let history = getHistory();

        // Check if this exact translation already exists
        const existingIndex = history.findIndex(
          (item) =>
            item.chinese === chineseText && item.georgian === georgianText
        );

        if (existingIndex !== -1) {
          // Remove existing and add to top
          history.splice(existingIndex, 1);
        }

        // Add to beginning of array
        history.unshift(historyItem);

        // Keep only last 50 translations
        if (history.length > 50) {
          history = history.slice(0, 50);
        }

        localStorage.setItem("translationHistory", JSON.stringify(history));
      }

      function getHistory() {
        try {
          const stored = localStorage.getItem("translationHistory");
          return stored ? JSON.parse(stored) : [];
        } catch (error) {
          console.error("Error reading history:", error);
          return [];
        }
      }

      function clearHistory() {
        if (
          confirm("Are you sure you want to clear all translation history?")
        ) {
          localStorage.removeItem("translationHistory");
          renderHistory();
        }
      }

      function openHistoryModal() {
        document.getElementById("historyModal").classList.remove("hidden");
        renderHistory();
        document.body.style.overflow = "hidden"; // Prevent background scrolling
      }

      function closeHistoryModal() {
        document.getElementById("historyModal").classList.add("hidden");
        document.body.style.overflow = "auto"; // Re-enable scrolling
      }

      function renderHistory() {
        const historyContent = document.getElementById("historyContent");
        const history = getHistory();

        if (history.length === 0) {
          historyContent.innerHTML = `
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-history text-4xl mb-4 opacity-50"></i>
              <p class="text-lg">No translation history yet</p>
              <p class="text-sm">Start translating to build your history</p>
            </div>
          `;
          return;
        }

        const historyHTML = history
          .map((item) => {
            const date = new Date(item.timestamp);
            const timeAgo = getTimeAgo(date);

            return `
            <div class="border border-gray-200 rounded-lg p-4 mb-3 hover:bg-gray-50 transition-colors cursor-pointer" onclick="useHistoryItem('${item.chinese.replace(
              /'/g,
              "\\'"
            )}', '${item.georgian.replace(/'/g, "\\'")}', '${(
              item.pinyin || ""
            ).replace(/'/g, "\\'")}')">
              <div class="flex justify-between items-start mb-2">
                <span class="text-xs text-gray-500">${timeAgo}</span>
                <button onclick="event.stopPropagation(); deleteHistoryItem(${
                  item.id
                })" class="text-red-400 hover:text-red-600 p-1">
                  <i class="fas fa-trash text-sm"></i>
                </button>
              </div>
              <div class="space-y-2">
                <div>
                  <span class="text-xs font-medium text-gray-600 uppercase tracking-wide">ჩინური:</span>
                  <p class="text-gray-800 font-medium">${item.chinese}</p>
                </div>
                ${
                  item.pinyin
                    ? `
                  <div>
                    <span class="text-xs font-medium text-blue-600 uppercase tracking-wide">ფინინი:</span>
                    <p class="text-blue-700 font-mono">/${item.pinyin}/</p>
                  </div>
                `
                    : ""
                }
                <div>
                  <span class="text-xs font-medium text-gray-600 uppercase tracking-wide">ქართული:</span>
                  <p class="text-gray-700">${item.georgian}</p>
                </div>
              </div>
            </div>
          `;
          })
          .join("");

        historyContent.innerHTML = historyHTML;
      }

      function deleteHistoryItem(id) {
        let history = getHistory();
        history = history.filter((item) => item.id !== id);
        localStorage.setItem("translationHistory", JSON.stringify(history));
        renderHistory();
      }

      function useHistoryItem(chineseText, georgianText, pinyinText) {
        // Fill the input with the selected translation
        document.getElementById("chineseInput").value = chineseText;

        // Update the output with only Georgian
        const output = document.getElementById("georgianOutput");
        output.textContent = georgianText;
        output.className =
          "w-full h-64 p-4 text-lg text-gray-900 overflow-y-auto";

        // Show pinyin tag if in Chinese mode and pinyin exists
        if (currentMode === "chinese" && pinyinText) {
          updatePinyinTag(pinyinText);
        } else {
          document.getElementById("pinyinTag").classList.add("hidden");
        }

        // Enable buttons
        const copyBtn = document.getElementById("copyBtn");
        const shareBtn = document.getElementById("shareBtn");
        copyBtn.disabled = false;
        shareBtn.disabled = false;
        copyBtn.classList.remove("opacity-50");
        shareBtn.classList.remove("opacity-50");

        // Update character count
        updateCharCount();

        // Close modal
        closeHistoryModal();
      }

      function getTimeAgo(date) {
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);

        if (diffInSeconds < 60) return "Just now";
        if (diffInSeconds < 3600)
          return `${Math.floor(diffInSeconds / 60)}m ago`;
        if (diffInSeconds < 86400)
          return `${Math.floor(diffInSeconds / 3600)}h ago`;
        if (diffInSeconds < 2592000)
          return `${Math.floor(diffInSeconds / 86400)}d ago`;

        return date.toLocaleDateString();
      }

      // Close modal when clicking outside
      document.addEventListener("click", function (event) {
        const modal = document.getElementById("historyModal");
        if (event.target === modal) {
          closeHistoryModal();
        }
      });

      // Close modal with Escape key
      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeHistoryModal();
        }
      });

      function updateCharCount() {
        const input = document.getElementById("chineseInput");
        const charCount = document.getElementById("charCount");
        charCount.textContent = input.value.length;
      }

      function handleInput() {
        updateCharCount();

        const input = document.getElementById("chineseInput").value.trim();
        const output = document.getElementById("georgianOutput");
        const copyBtn = document.getElementById("copyBtn");
        const shareBtn = document.getElementById("shareBtn");

        // Clear any existing timer
        if (debounceTimer) {
          clearTimeout(debounceTimer);
        }

        if (!input) {
          output.textContent = "ტრანსლიტერაცია გამოჩნდება აქ...";
          output.className =
            "w-full h-64 p-4 text-lg text-gray-400 overflow-y-auto";
          copyBtn.disabled = true;
          shareBtn.disabled = true;
          copyBtn.classList.add("opacity-50");
          shareBtn.classList.add("opacity-50");
          return;
        }

        // Show "typing..." immediately for visual feedback
        if (!isTranslating) {
          output.textContent = "Typing...";
          output.className =
            "w-full h-64 p-4 text-lg text-gray-400 overflow-y-auto";
        }

        // Set a new timer to translate after user stops typing
        debounceTimer = setTimeout(() => {
          if (!isTranslating) {
            convertText(input);
          }
        }, 800); // Wait 800ms after user stops typing
      }

      function convertText(text) {
        if (isTranslating) return;

        isTranslating = true;
        const output = document.getElementById("georgianOutput");

        output.textContent = "Translating...";
        output.className =
          "w-full h-64 p-4 text-lg text-gray-400 overflow-y-auto";

        const payload = { text: text };

        fetch("/convert", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            displayResult(data);
          })
          .catch((error) => {
            console.error("Error:", error);
            const output = document.getElementById("georgianOutput");
            output.textContent = "Translation error. Please try again.";
            output.className =
              "w-full h-64 p-4 text-lg text-red-500 overflow-y-auto";
          })
          .finally(() => {
            isTranslating = false;
          });
      }

      function displayResult(data) {
        const output = document.getElementById("georgianOutput");
        const copyBtn = document.getElementById("copyBtn");
        const shareBtn = document.getElementById("shareBtn");
        const input = document.getElementById("chineseInput");
        // Reset other pinyin between renders to avoid stale values
        window.__otherPinyin = [];

        if (data.error) {
          output.textContent = data.error;
          output.className =
            "w-full h-64 p-4 text-lg text-red-500 overflow-y-auto";
          copyBtn.disabled = true;
          shareBtn.disabled = true;
          copyBtn.classList.add("opacity-50");
          shareBtn.classList.add("opacity-50");
          // Hide pinyin tag on error
          document.getElementById("pinyinTag").classList.add("hidden");
          return;
        }

        let georgianResult = "";
        let pinyinResult = "";

        if (data.special) {
          georgianResult = data.special.ქართული;
          pinyinResult = data.special.pinyin;
        } else {
          for (const [key, value] of Object.entries(data)) {
            if (value && typeof value === "object" && value.ქართული) {
              georgianResult = value.ქართული;
              pinyinResult = value.pinyin;
              window.__otherPinyin = Array.isArray(value.other_pinyin)
                ? value.other_pinyin
                : [];
              break;
            }
          }
        }

        if (georgianResult) {
          // Show only Georgian in the output area
          output.textContent = georgianResult;
          output.className =
            "w-full h-64 p-4 text-lg text-gray-900 overflow-y-auto";

          // Show pinyin as a tag below the input (only in Chinese mode)
          if (currentMode === "chinese" && pinyinResult) {
            updatePinyinTag(pinyinResult, window.__otherPinyin || []);
          } else {
            document.getElementById("pinyinTag").classList.add("hidden");
          }

          copyBtn.disabled = false;
          shareBtn.disabled = false;
          copyBtn.classList.remove("opacity-50");
          shareBtn.classList.remove("opacity-50");

          // Save to history
          const chineseText = input.value.trim();
          if (chineseText && georgianResult) {
            saveToHistory(chineseText, georgianResult, pinyinResult);
          }
        } else {
          output.textContent = "No translation available.";
          output.className =
            "w-full h-64 p-4 text-lg text-gray-500 overflow-y-auto";
          copyBtn.disabled = true;
          shareBtn.disabled = true;
          copyBtn.classList.add("opacity-50");
          shareBtn.classList.add("opacity-50");
          // Hide pinyin tag when no result
          document.getElementById("pinyinTag").classList.add("hidden");
        }
      }

      function updatePinyinTag(pinyinText, otherList) {
        const pinyinTag = document.getElementById("pinyinTag");
        const pinyinTextElement = document.getElementById("pinyinText");
        const otherWrapper = document.getElementById("otherPinyinWrapper");
        const otherTextElement = document.getElementById("otherPinyinText");

        if (pinyinText) {
          pinyinTextElement.textContent = `/${pinyinText}/`;
          // Handle other readings
          if (Array.isArray(otherList) && otherList.length > 0) {
            otherTextElement.textContent = otherList
              .map((p) => `/${p}/`)
              .join(" ");
            otherWrapper.classList.remove("hidden");
          } else {
            otherWrapper.classList.add("hidden");
            otherTextElement.textContent = "";
          }
          pinyinTag.classList.remove("hidden");
        } else {
          pinyinTag.classList.add("hidden");
          otherWrapper.classList.add("hidden");
          otherTextElement.textContent = "";
        }
      }

      // Copy functionality
      document
        .getElementById("copyBtn")
        .addEventListener("click", async function () {
          const output = document.getElementById("georgianOutput");
          if (
            output.textContent &&
            !output.textContent.includes("Tტრანსლიტერაცია გამოჩნდება აქ")
          ) {
            try {
              // Copy Georgian text directly
              const textToCopy = output.textContent.trim();

              // Try modern clipboard API first
              if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(textToCopy);
              } else {
                // Fallback for older browsers or non-HTTPS
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "fixed";
                textArea.style.left = "-999999px";
                textArea.style.top = "-999999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand("copy");
                textArea.remove();
              }

              // Show success feedback
              const originalText = this.innerHTML;
              this.innerHTML =
                '<i class="fas fa-check text-green-500 text-lg"></i>';
              setTimeout(() => {
                this.innerHTML = originalText;
              }, 1500);
            } catch (error) {
              console.error("Copy failed:", error);

              // Show error feedback
              const originalText = this.innerHTML;
              this.innerHTML =
                '<i class="fas fa-times text-red-500 text-lg"></i>';
              setTimeout(() => {
                this.innerHTML = originalText;
              }, 1500);
            }
          }
        });

      // Share functionality
      document
        .getElementById("shareBtn")
        .addEventListener("click", async function () {
          const output = document.getElementById("georgianOutput");
          const input = document.getElementById("chineseInput");

          if (
            output.textContent &&
            !output.textContent.includes("ტრანსლიტერაცია გამოჩნდება აქ...")
          ) {
            // Get Georgian text directly
            const georgianText = output.textContent.trim();

            // Get pinyin from tag if visible
            const pinyinTag = document.getElementById("pinyinTag");
            const pinyinElement = document.getElementById("pinyinText");
            const pinyinText = !pinyinTag.classList.contains("hidden")
              ? pinyinElement.textContent.trim()
              : "";

            let shareText = `Chinese: ${input.value}`;
            if (pinyinText) {
              shareText += `\nPinyin: ${pinyinText}`;
            }
            shareText += `\nGeorgian: ${georgianText}`;

            const shareData = {
              title: "Chinese to Georgian Translation",
              text: shareText,
              url: window.location.href,
            };

            try {
              // Try native Web Share API first (mobile)
              if (
                navigator.share &&
                navigator.canShare &&
                navigator.canShare(shareData)
              ) {
                await navigator.share(shareData);
                console.log("Shared successfully");
              } else {
                // Fallback: copy to clipboard with share format
                const fullShareText = `${shareText}\n\nTranslated at: ${window.location.href}`;

                if (navigator.clipboard && window.isSecureContext) {
                  await navigator.clipboard.writeText(fullShareText);
                } else {
                  // Fallback for older browsers
                  const textArea = document.createElement("textarea");
                  textArea.value = fullShareText;
                  textArea.style.position = "fixed";
                  textArea.style.left = "-999999px";
                  textArea.style.top = "-999999px";
                  document.body.appendChild(textArea);
                  textArea.focus();
                  textArea.select();
                  document.execCommand("copy");
                  textArea.remove();
                }

                // Show feedback that it was copied
                alert("Translation copied to clipboard for sharing!");
              }

              // Visual feedback
              const originalText = this.innerHTML;
              this.innerHTML =
                '<i class="fas fa-check text-blue-custom text-lg"></i>';
              setTimeout(() => {
                this.innerHTML = originalText;
              }, 1500);
            } catch (error) {
              console.error("Share failed:", error);

              // Show error feedback
              const originalText = this.innerHTML;
              this.innerHTML =
                '<i class="fas fa-times text-red-500 text-lg"></i>';
              setTimeout(() => {
                this.innerHTML = originalText;
              }, 1500);
            }
          }
        });

      // Auto-resize textarea (optional enhancement)
      document
        .getElementById("chineseInput")
        .addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 256) + "px";
        });
    </script>
  </body>
</html>
